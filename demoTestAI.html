<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-Ra IoT Buttons</title>
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #1e1e2f, #2a2a40);
        color: #fff;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      .container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }

      .button {
        width: 100px;
        height: 100px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: linear-gradient(145deg, #3a3a5a, #2a2a40);
        border: none;
        border-radius: 15px;
        color: #fff;
        font-size: 18px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
      }

      .button.active {
        background: linear-gradient(145deg, #4caf50, #388e3c);
        box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
      }

      .button:active {
        transform: scale(0.95);
      }

      .button:hover:not(.active) {
        background: linear-gradient(145deg, #4a4a6a, #3a3a5a);
      }

      .button.disabled {
        background: #555;
        cursor: not-allowed;
        opacity: 0.6;
      }

      @media (max-width: 600px) {
        .container {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button
        id="button-0"
        class="button"
        onclick="controlButton(0, !this.classList.contains('active'))"
      >
        OFF
      </button>
      <button
        id="button-1"
        class="button"
        onclick="controlButton(1, !this.classList.contains('active'))"
      >
        OFF
      </button>
      <button
        id="button-2"
        class="button"
        onclick="controlButton(2, !this.classList.contains('active'))"
      >
        OFF
      </button>
      <button
        id="button-3"
        class="button"
        onclick="controlButton(3, !this.classList.contains('active'))"
      >
        OFF
      </button>
    </div>

    <script>
      const eraWidget = new EraWidget();
      let realtimeConfigs = new Array(1).fill(null); // 1 sensor configs
      let actionConfigs = new Array(8).fill(null); // 8 action configs (4 buttons × 2 + 0 sliders × 2)
      let isConfigured = false; // Flag kiểm tra đã config chưa

      eraWidget.init({
        onConfiguration: (configuration) => {
          console.log("E-Ra Configuration received:", configuration);
          // Cấu hình 1 sensor(s) - sử dụng realtime_configs
          if (
            configuration.realtime_configs &&
            configuration.realtime_configs[0]
          ) {
            realtimeConfigs[0] = configuration.realtime_configs[0]; // Sensor 1
          }
          // Cấu hình 4 button(s) + 0 slider(s) - sử dụng actions
          // Button 1: ON/OFF actions
          if (configuration.actions && configuration.actions[0]) {
            actionConfigs[0] = configuration.actions[0]; // Button 1 ON
          }
          if (configuration.actions && configuration.actions[1]) {
            actionConfigs[1] = configuration.actions[1]; // Button 1 OFF
          }
          // Button 2: ON/OFF actions
          if (configuration.actions && configuration.actions[2]) {
            actionConfigs[2] = configuration.actions[2]; // Button 2 ON
          }
          if (configuration.actions && configuration.actions[3]) {
            actionConfigs[3] = configuration.actions[3]; // Button 2 OFF
          }
          // Button 3: ON/OFF actions
          if (configuration.actions && configuration.actions[4]) {
            actionConfigs[4] = configuration.actions[4]; // Button 3 ON
          }
          if (configuration.actions && configuration.actions[5]) {
            actionConfigs[5] = configuration.actions[5]; // Button 3 OFF
          }
          // Button 4: ON/OFF actions
          if (configuration.actions && configuration.actions[6]) {
            actionConfigs[6] = configuration.actions[6]; // Button 4 ON
          }
          if (configuration.actions && configuration.actions[7]) {
            actionConfigs[7] = configuration.actions[7]; // Button 4 OFF
          }
          isConfigured = true;
        },
        onValues: (values) => {
          // Cập nhật giá trị từ 1 sensor(s)
          realtimeConfigs.forEach((config, index) => {
            if (config && values[config.id]) {
              const sensorValue = values[config.id].value;
              updateSensorDisplay(index, sensorValue);
            }
          });
        },
      });

      function controlButton(buttonIndex, isOn) {
        if (!isConfigured) {
          console.warn("E-Ra chưa được cấu hình. Vui lòng đợi...");
          return;
        }

        // Mỗi button có 2 actions: [buttonIndex*2] = ON, [buttonIndex*2+1] = OFF
        const actionIndex = buttonIndex * 2 + (isOn ? 0 : 1);

        if (actionConfigs[actionIndex]) {
          console.log(`Button ${buttonIndex + 1} ${isOn ? "ON" : "OFF"}`);
          eraWidget.triggerAction(actionConfigs[actionIndex].action, null, {
            value: isOn ? 1 : 0,
          });
          updateButtonState(buttonIndex, isOn);
        } else {
          console.error(`Button ${buttonIndex + 1} action chưa được cấu hình`);
        }
      }

      function updateButtonState(buttonIndex, isOn) {
        const buttonElement = document.getElementById(`button-${buttonIndex}`);
        if (buttonElement) {
          buttonElement.classList.toggle("active", isOn);
          buttonElement.textContent = isOn ? "ON" : "OFF";
        }
      }

      function updateSensorDisplay(sensorIndex, value) {
        const sensorElement = document.getElementById(`sensor-${sensorIndex}`);
        if (sensorElement) {
          sensorElement.textContent = value;
          sensorElement.classList.add("updated");
          setTimeout(() => sensorElement.classList.remove("updated"), 300);
        }
      }
    </script>
  </body>
</html>
