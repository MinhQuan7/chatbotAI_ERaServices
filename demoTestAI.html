<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-Ra IoT Control</title>
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: linear-gradient(135deg, #1e1e2f, #2a2a40);
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }
      .container {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
        padding: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      }
      .control-btn {
        padding: 15px 30px;
        border: none;
        border-radius: 10px;
        background: linear-gradient(135deg, #6a11cb, #2575fc);
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        outline: none;
      }
      .control-btn.active {
        background: linear-gradient(135deg, #2575fc, #6a11cb);
        box-shadow: 0 0 15px rgba(37, 117, 252, 0.6);
      }
      .control-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      @media (max-width: 480px) {
        .control-btn {
          padding: 10px 20px;
          font-size: 14px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button id="control-0" class="control-btn" onclick="toggleControl(0)">
        Button 1
      </button>
      <button id="control-2" class="control-btn" onclick="toggleControl(2)">
        Button 2
      </button>
    </div>

    <script>
      // Khai báo variables
      const eraWidget = new EraWidget();
      let actionConfigs = new Array(4).fill(null);
      let isConfigured = false;

      // Khởi tạo E-Ra Widget
      eraWidget.init({
        onConfiguration: (configuration) => {
          console.log("E-Ra Configuration received:", configuration);
          if (configuration.actions && configuration.actions[0]) {
            actionConfigs[0] = configuration.actions[0];
          }
          if (configuration.actions && configuration.actions[1]) {
            actionConfigs[1] = configuration.actions[1];
          }
          if (configuration.actions && configuration.actions[2]) {
            actionConfigs[2] = configuration.actions[2];
          }
          if (configuration.actions && configuration.actions[3]) {
            actionConfigs[3] = configuration.actions[3];
          }
          isConfigured = true;
        },
        onValues: (values) => {
          // Lắng nghe giá trị realtime từ các cảm biến
        },
      });

      // Hàm điều khiển thiết bị
      function controlDevice(actionIndex, isOn) {
        if (!isConfigured) {
          console.warn("E-Ra chưa được cấu hình. Vui lòng đợi...");
          return;
        }
        if (actionConfigs[actionIndex] && actionConfigs[actionIndex].action) {
          const value = isOn ? 1 : 0;
          console.log(`Controlling device ${actionIndex}: ${value}`);
          eraWidget.triggerAction(actionConfigs[actionIndex].action, null, {
            value: value,
          });
          updateControlState(actionIndex, isOn);
        } else {
          console.error(
            `Action config ${actionIndex} chưa được thiết lập đúng`
          );
        }
      }

      // Hàm cập nhật trạng thái giao diện
      function updateControlState(controlIndex, value) {
        const controlElement = document.getElementById(
          `control-${controlIndex}`
        );
        if (controlElement) {
          controlElement.classList.toggle("active", value > 0);
        }
      }

      // Hàm toggle control
      function toggleControl(index) {
        const controlElement = document.getElementById(`control-${index}`);
        const isActive = controlElement.classList.contains("active");
        controlDevice(index, !isActive);
      }
    </script>
  </body>
</html>
