<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>E-Ra Widget Control</title>
    <script src="https://www.unpack.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #212121;
        color: #f5f5f5;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }
      .control-container {
        background: rgba(255, 255, 255, 0.1);
        padding: 40px;
        border-radius: 20px;
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 20px;
      }
      .control-button {
        padding: 20px 30px;
        border: none;
        border-radius: 10px;
        background-color: #333;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease;
      }
      .control-button:hover {
        background-color: #444;
      }
      .control-button.active {
        background-color: #00ff88;
        color: #000;
      }
      .control-button:disabled {
        background-color: #555;
        cursor: not-allowed;
      }
      .loading-text {
        color: #888;
        font-size: 14px;
        text-align: center;
        grid-column: span 2;
      }
    </style>
  </head>
  <body>
    <div class="control-container">
      <button
        id="control-0"
        class="control-button"
        onclick="controlDevice(0, true)"
      >
        ON
      </button>
      <button
        id="control-1"
        class="control-button"
        onclick="controlDevice(1, false)"
      >
        OFF
      </button>
      <div id="loading" class="loading-text">Loading configuration...</div>
    </div>

    <script>
      const eraWidget = new EraWidget();
      let actionConfigs = new Array(2).fill(null);
      let isConfigured = false;

      eraWidget.init({
        onConfiguration: (configuration) => {
          console.log("E-Ra Configuration received:", configuration);
          if (configuration.actions && configuration.actions[0]) {
            actionConfigs[0] = configuration.actions[0];
          }
          if (configuration.actions && configuration.actions[1]) {
            actionConfigs[1] = configuration.actions[1];
          }
          isConfigured = true;
          document.getElementById("loading").style.display = "none";
        },
        onValues: (values) => {
          console.log("Real-time values received:", values);
        },
      });

      function controlDevice(actionIndex, isOn) {
        if (!isConfigured) {
          console.warn("E-Ra chưa được cấu hình. Vui lòng đợi...");
          return;
        }

        if (actionConfigs[actionIndex] && actionConfigs[actionIndex].action) {
          const value = isOn ? 1 : 0;
          console.log(`Controlling device ${actionIndex}: ${value}`);
          eraWidget.triggerAction(actionConfigs[actionIndex].action, null, {
            value: value,
          });
          updateControlState(actionIndex, isOn);
        } else {
          console.error(
            `Action config ${actionIndex} chưa được thiết lập đúng`
          );
        }
      }

      function updateControlState(controlIndex, value) {
        const controlElement = document.getElementById(
          `control-${controlIndex}`
        );
        if (controlElement) {
          controlElement.classList.toggle("active", value > 0);
        }
      }
    </script>
  </body>
</html>
